<div class="checkout-form-container"
     data-controller="checkout-form form-validation"
     data-form-validation-translations-value="<%= helpers.validation_translations_for_js %>"
     data-checkout-form-form-validation-outlet=".checkout-form-container">
  <%# Turbo disabled: Full page navigation required for order processing and payment flow %>
  <%= form_with model: checkout_form, url: checkout_path, local: true, data: { turbo: false }, html: { class: "checkout-form" } do |f| %>
    <!-- Section 1: Address & Delivery -->
    <section class="checkout-section">
      <div class="checkout-section-header">
        <h3 class="checkout-section-title"><%= t('checkout.form.sections.address_and_delivery') %></h3>
      </div>
      <div class="space-y-6">
        <%= f.hidden_field :city, value: store_city %>
        <%= f.hidden_field :governorate, value: effective_governorate %>
        <!-- Delivery Method -->
        <%= render FormFieldComponent.new(
          form: f,
          field: :delivery_method,
          type: :radio_group,
          required: true,
          options: {
            options: delivery_method_options,
            radio_action: "change->checkout-form#handleDeliveryMethodChange"
          }
        ) %>
        <!-- Dynamic Delivery Summary -->
        <div id="delivery-summary" data-checkout-form-target="deliverySummary">
          <%= render Checkout::DeliverySummaryComponent.new(
            delivery_method: effective_delivery_method,
            address_data: delivery_summary_address_data,
            city: effective_city
          ) %>
        </div>
        <%= f.hidden_field :delivery_date %>
        <%= f.hidden_field :delivery_time_slot %>
        <!-- Delivery Date/Time Picker -->
        <div class="form-field">
          <label class="text-sm font-medium text-gray-700 mb-4 block"><%= t('checkout.form.sections.delivery_date_time') %></label>
          <div id="delivery-schedule" data-checkout-form-target="deliverySchedule">
            <%= render DeliveryScheduleInlineComponent.new(
              delivery_method: effective_delivery_method,
              selected_date: checkout_form.delivery_date,
              selected_time: checkout_form.delivery_time_slot
            ) %>
          </div>
        </div>
      </div>
    </section>
    <!-- Section 2: Recipient -->
    <section class="checkout-section">
      <div class="checkout-section-header">
        <h3 class="checkout-section-title"><%= t('checkout.form.sections.recipient') %></h3>
      </div>
      <div class="space-y-6">
        <!-- Contacts -->
        <div>
          <h4 class="text-sm font-medium text-gray-700 mb-4"><%= t('checkout.form.sections.contacts') %></h4>
          <div class="checkout-form-grid">
            <%= render FormFieldComponent.new(
              form: f,
              field: :phone_number,
              type: :phone,
              required: true,
              placeholder: t('checkout.form.placeholders.phone_number'),
              validation_rules: "phone",
              options: { helper_text: t('checkout.form.helper_text.phone_coordination') }
            ) %>
            <%= render FormFieldComponent.new(
              form: f,
              field: :email,
              type: :email,
              required: true,
              placeholder: t('checkout.form.placeholders.email'),
              validation_rules: "email",
              options: { helper_text: t('checkout.form.helper_text.email_receipt') }
            ) %>
          </div>
        </div>
        <!-- Personal Data -->
        <div>
          <h4 class="text-sm font-medium text-gray-700 mb-4"><%= t('checkout.form.sections.personal_data') %></h4>
          <div class="checkout-form-grid">
            <%= render FormFieldComponent.new(
              form: f,
              field: :first_name,
              required: true,
              placeholder: t('checkout.form.placeholders.first_name'),
              validation_rules: "first_name"
            ) %>
            <%= render FormFieldComponent.new(
              form: f,
              field: :last_name,
              required: true,
              placeholder: t('checkout.form.placeholders.last_name'),
              validation_rules: "last_name"
            ) %>
          </div>
        </div>
        <!-- Save Profile Info Checkbox -->
        <% if Current.user && (Current.user.first_name.blank? || Current.user.phone_number.blank?) %>
          <div class="pt-4 border-t border-gray-200">
            <%= render FormFieldComponent.new(
              form: f,
              field: :save_profile_info,
              type: :checkbox,
              options: {
                label: t('checkout.form.recipient.save_profile_info'),
                helper_text: t('checkout.form.recipient.save_profile_info_help'),
                css_class: "flex items-start"
              }
            ) %>
          </div>
        <% end %>
      </div>
    </section>
    <!-- Section 3: Payment Method -->
    <section class="checkout-section">
      <div class="checkout-section-header">
        <h3 class="checkout-section-title"><%= t('checkout.form.sections.payment_method') %></h3>
      </div>
      <%= render FormFieldComponent.new(
        form: f,
        field: :payment_method,
        type: :radio_group,
        required: true,
        options: {
          options: payment_method_options,
          descriptions: payment_method_descriptions
        }
      ) %>
    </section>
    <!-- Submit Button -->
    <div class="pt-6">
      <%= f.submit t('checkout.form.buttons.place_order'),
          class: "btn-interactive btn-full btn-lg uppercase tracking-wide",
          data: {
            turbo_submits_with: t('checkout.form.buttons.placing_order'),
            disable_with: t('checkout.form.buttons.placing_order'),
            "form-validation-target": "submitButton"
          } %>
    </div>
    <!-- Modals -->
    <div data-checkout-form-target="modals">
      <% address_modal = Checkout::Modals::AddressModalComponent.new(form: f, city: effective_city) %>
      <%= render address_modal do |modal| %>
        <% modal.with_body do %>
          <%= render partial: "checkout/modals/address_modal_body",
                     locals: {
                       form: f,
                       delivery_card: DeliveryCardComponent.new(**address_modal.delivery_card_props),
                       show_save_checkbox: Current.user && !Current.user.customer_profile&.has_default_address?,
                       submit_props: address_modal.submit_button_props
                     } %>
        <% end %>
      <% end %>
      <% pickup_modal = Checkout::Modals::PickupDetailsModalComponent.new %>
      <%= render pickup_modal do |modal| %>
        <% modal.with_body do %>
          <%= render partial: "checkout/modals/pickup_details_body",
                     locals: {
                       store_info: pickup_modal.store_info
                     } %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
